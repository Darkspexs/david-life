<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>David Life</title>
    <style>
        body { font-family: 'Courier New', Courier, monospace; display: flex; flex-direction: column; align-items: center; justify-content: center; min-height: 100vh; margin: 0; background-color: #333; color: #fff; touch-action: manipulation; }
        #gameContainer { position: relative; display: flex; flex-direction: column; align-items: center; border: 2px solid #555; padding: 20px; background-color: #444; box-shadow: 0 0 15px rgba(0,0,0,0.5); }
        canvas { border: 1px solid #888; image-rendering: pixelated; image-rendering: -moz-crisp-edges; image-rendering: crisp-edges; margin-bottom: 10px; cursor: default; transition: background-color 1s linear; }
        .game-info { display: flex; justify-content: space-between; width: 100%; margin-bottom: 10px; font-size: 14px; padding: 0 5px; }
        #playtimeDisplay {
            position: fixed;
            top: 18px;
            right: 38px;
            font-size: 13px;
            color: #ccc;
            z-index: 300;
            background: none;
            box-shadow: none;
            padding: 0;
            margin: 0;
            pointer-events: none;
        }
        .controls, .stats-display { display: flex; flex-wrap: wrap; justify-content: center; gap: 8px; margin-bottom: 10px; }
        button { background-color: #5cb85c; color: white; border: none; padding: 8px 12px; text-align: center; text-decoration: none; display: inline-block; font-size: 12px; cursor: pointer; border-radius: 5px; font-family: 'Courier New', Courier, monospace; }
        button:hover { background-color: #4cae4c; }
        button:disabled { background-color: #aaa; cursor: not-allowed; }
        .stat-bar-container { width: 70px; height: 18px; background-color: #666; border-radius: 3px; overflow: hidden; margin-top: 2px; }
        .stat-bar { height: 100%; background-color: #4CAF50; width: 0%; transition: width 0.3s ease-out; }
        .stat-item { display: flex; flex-direction: column; align-items: center; font-size: 10px; }
        #messageArea { min-height: 18px; font-style: italic; color: #ffeb3b; text-align: center; margin-bottom: 8px; font-size: 12px; }
        #jobControls button { background-color: #f0ad4e; } #jobControls button:hover { background-color: #ec971f; }
        #lookForJobButton { background-color: #337ab7; } #lookForJobButton:hover { background-color: #286090; }
        #gambleButton { background-color: #d9534f; } #gambleButton:hover { background-color: #c9302c; }
        #gameOverScreen { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.8); display: none; flex-direction: column; align-items: center; justify-content: center; z-index: 100; color: white; text-align: center; }
        #gameOverScreen h2 { font-size: 3em; margin-bottom: 20px; } #gameOverScreen p { font-size: 1.2em; margin-bottom: 30px; }
        .minigame-overlay, #jobChoiceOverlay, #blackjackOverlay { position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); background-color: rgba(0,0,0,0.9); padding: 20px 30px; border-radius: 10px; z-index: 50; text-align: center; display: none; box-shadow: 0 0 20px rgba(0,0,0,0.7); color: #fff; width: auto; min-width: 300px; max-width: 90%; font-size: 14px; }
        .minigame-overlay p, #jobChoiceOverlay p, #blackjackOverlay p { margin: 8px 0; line-height: 1.4; }
        .minigame-overlay .minigame-title, #jobChoiceOverlay .overlay-title, #blackjackOverlay .minigame-title { font-size: 1.3em; font-weight: bold; margin-bottom: 15px; color: #f0ad4e; }
        .minigame-overlay .challenge-text { font-size: 1.5em; color: #FFFF00; margin: 10px 0 15px 0; font-weight: bold; }
        .minigame-overlay input[type="text"], #blackjackBetInput { font-family: 'Courier New',Courier,monospace; padding: 10px; margin-top: 10px; margin-bottom: 15px; font-size: 1.2em; border-radius: 5px; border: 1px solid #555; background-color: #222; color: #fff; text-align: center; width: 80%; max-width: 250px; }
        #blackjackBetInput { padding: 8px; font-size: 1em; width: 70px; margin-right: 10px;}
        .minigame-overlay .status-line { display: flex; justify-content: space-around; align-items: center; font-size: 0.9em; color: #ccc; margin-top: 15px; }
        .minigame-overlay .status-line span { margin: 0 5px; }
        .minigame-canvas-info { position: absolute; top: 5px; left: 50%; transform: translateX(-50%); background-color: rgba(0,0,0,0.6); color: white; padding: 3px 8px; border-radius: 5px; font-size: 11px; z-index: 40; }
        #pauseOverlay { position: fixed; top:0; left:0; width:100%; height:100%; background-color:rgba(0,0,0,0.6); display:none; flex-direction:column; align-items:center; justify-content:center; z-index:200; color:white; font-size:2em; text-align:center; }
        .minigame-button { background-color: #5bc0de; color: white; border:1px solid #46b8da; padding: 10px 15px; margin: 10px 5px; font-size: 14px; cursor:pointer; }
        .minigame-sequence-block { width: 35px; height: 35px; margin: 8px; display: inline-block; border: 2px solid #fff; cursor: pointer; border-radius: 5px; }
        #sequenceDisplay { margin-bottom: 15px; }
        #credits { position: absolute; bottom: 5px; left: 10px; font-size: 10px; color: #777; }
        /* Job Choice Overlay */
        #jobChoiceContainer { display: flex; flex-direction: column; gap: 15px; margin-top: 15px; }
        .job-option { background-color: #3a3a3a; padding: 10px; border-radius: 8px; border: 1px solid #555; }
        .job-option p { margin: 4px 0; }
        .job-option .job-title { font-weight: bold; color: #f0ad4e; font-size: 1.1em;}
        .job-option .job-detail { font-size: 0.9em; color: #ccc; }
        .job-option .job-toll-high { color: #ff6b6b; } /* Red for high toll */
        .job-option .job-toll-medium { color: #ffcc6b; } /* Yellow for medium */
        .job-option .job-toll-low { color: #90ee90; } /* Green for low */
        .job-option button { background-color: #5cb85c; margin-top: 8px; padding: 6px 10px; font-size: 11px;}
        .job-option.current-job { border-color: #aaa; background-color: #454545; }
        .job-option.current-job button { background-color: #888; }
        /* Blackjack Overlay */
        #blackjackOverlay .card-display { display: flex; flex-wrap: wrap; justify-content: center; min-height: 50px; margin-bottom: 10px; background-color: #2a522a; padding: 5px; border-radius: 5px;}
        #blackjackOverlay .card { background-color: #fff; color: #333; border: 1px solid #000; border-radius: 5px; padding: 8px 5px; margin: 3px; min-width: 35px; text-align: center; font-family: Arial, sans-serif; font-size: 16px; font-weight: bold; }
        #blackjackOverlay .card.red { color: #D90000; }
        #blackjackOverlay .card.hidden { background-color: #aaa; color: #aaa; content: "?"; }
        #blackjackOverlay .blackjack-hand-area { margin-bottom: 15px; }
        #blackjackMessage { min-height: 1.5em; font-weight: bold; }

    </style>
</head>
<body>
    <span id="playtimeDisplay">Playtime: 00:00:00</span>
    <div id="gameContainer">
        <h1>David Life</h1>
        <div class="game-info">
            <span id="moneyDisplay">Money: $100</span>
            <span id="ageDisplay">Age: 0 days (Egg)</span>
            <span id="rentDisplay">Rent: $0</span>
        </div>
        <div style="position: relative;">
            <canvas id="gameCanvas" width="320" height="240"></canvas>
            <div id="canvasMinigameInfo" class="minigame-canvas-info" style="display:none;"></div>
        </div>
        <div id="messageArea">Welcome to David Life!</div>
        <div id="jobInfoArea" style="font-size: 12px; margin-bottom: 5px; text-align: center;">Job: None</div>
        <div class="stats-display">
            <div class="stat-item"><span>Happiness</span><div class="stat-bar-container"><div id="happinessBar" class="stat-bar"></div></div></div>
            <div class="stat-item"><span>Hunger</span><div class="stat-bar-container"><div id="hungerBar" class="stat-bar"></div></div></div>
            <div class="stat-item"><span>Cleanliness</span><div class="stat-bar-container"><div id="cleanlinessBar" class="stat-bar"></div></div></div>
            <div class="stat-item"><span>Energy</span><div class="stat-bar-container"><div id="energyBar" class="stat-bar"></div></div></div>
            <div class="stat-item"><span>Smartness</span><div class="stat-bar-container"><div id="smartnessBar" class="stat-bar"></div></div></div>
            <div class="stat-item"><span>Experience</span><div class="stat-bar-container"><div id="experienceBar" class="stat-bar" style="background-color: #f0ad4e;"></div></div></div>
        </div>
        <div class="controls">
            <button id="feedButton">Feed ($5)</button> <button id="cleanButton">Clean ($3)</button> <button id="playButton">Play ($2)</button> <button id="studyButton">Study ($10)</button> <button id="sleepButton">Sleep</button> <button id="gambleButton">Gamble</button>
        </div>
        <div id="jobControls" class="controls">
            <button id="choreButton" style="display:none;">Do Chore</button> <button id="jobButton" style="display:none;">Work</button> <button id="promotionButton" style="display:none;">Ask Promotion</button> <button id="lookForJobButton" style="display:none;">Find New Job</button>
        </div>
        <div id="credits">Made by Darkspecs</div>
    </div>

    <div id="gameOverScreen"><h2>Game Over</h2><p id="finalMessage"></p><button id="restartButton">Restart</button></div>
    <div id="typingMinigameOverlay" class="minigame-overlay"><p class="minigame-title">Data Entry</p><p>Type the word:</p><p id="typingChallengeText" class="challenge-text"></p><input type="text" id="typingInput" autofocus><p class="status-line"><span><span id="typingWordsCompleted">0</span>/<span id="typingWordsTotal">0</span> words</span><span>Time: <span id="typingTimeLeft"></span>s</span></p></div>
    <div id="programmerMinigameOverlay" class="minigame-overlay"><p class="minigame-title">Programmer Trainee</p><p>Repeat the sequence!</p><div id="sequenceDisplay"></div><p>Your Turn! Click the blocks in order.</p><p class="status-line"><span>Score: <span id="programmerScore">0</span>/<span id="programmerTargetScore">0</span></span><span>Time: <span id="programmerTimeLeft"></span>s</span></p></div>
    <div id="managerMinigameOverlay" class="minigame-overlay"><p class="minigame-title">Junior Manager</p><p>Approve tasks quickly!</p><div id="managerTaskArea" style="height:100px;display:flex;align-items:center;justify-content:center;"></div><p class="status-line"><span>Approved: <span id="managerTasksDone">0</span>/<span id="managerTasksTotal">0</span></span><span>Time: <span id="managerTimeLeft"></span>s</span></p></div>
    <div id="pauseOverlay">Game Paused</div>
    <div id="jobChoiceOverlay" class="minigame-overlay">
        <p class="overlay-title">Job Opportunities</p>
        <p>Consider these options based on your skills:</p>
        <div id="jobChoiceContainer"></div>
    </div>
    <div id="blackjackOverlay" class="minigame-overlay">
        <p class="minigame-title">Blackjack</p>
        <div id="blackjackTable">
            <div class="blackjack-hand-area">
                <p>Dealer's Hand (<span id="blackjackDealerScore">0</span>):</p>
                <div id="blackjackDealerHand" class="card-display"></div>
            </div>
            <div class="blackjack-hand-area">
                <p>Your Hand (<span id="blackjackPlayerScore">0</span>):</p>
                <div id="blackjackPlayerHand" class="card-display"></div>
            </div>
        </div>
        <p id="blackjackMessage"></p>
        <div id="blackjackBetControls">
            <label for="blackjackBetInput">Bet: $</label>
            <input type="number" id="blackjackBetInput" value="10" min="1">
            <button id="blackjackDealButton" class="minigame-button">Deal</button>
        </div>
        <div id="blackjackActionControls" style="display:none;">
            <button id="blackjackHitButton" class="minigame-button">Hit</button>
            <button id="blackjackStandButton" class="minigame-button">Stand</button>
        </div>
        <button id="blackjackCloseButton" class="minigame-button" style="margin-top:15px; background-color: #c9302c;">Close Table</button>
    </div>


    <script>
        const canvas = document.getElementById('gameCanvas'); const ctx = canvas.getContext('2d');
        const canvasMinigameInfo = document.getElementById('canvasMinigameInfo'); const pauseOverlay = document.getElementById('pauseOverlay');
        const playtimeDisplay = document.getElementById('playtimeDisplay');
        const jobChoiceOverlay = document.getElementById('jobChoiceOverlay');
        const jobChoiceContainer = document.getElementById('jobChoiceContainer');
        const blackjackOverlay = document.getElementById('blackjackOverlay'); // Blackjack overlay

        const PIXEL_SCALE = 4; const STAT_DECAY_INTERVAL = 2500; const AGE_SPEED = 10000 * 1.2;
        const STARTING_MONEY = 100; const COSTS = { feed: 5, clean: 3, play: 2, study: 10 };
        const RENT_BASE_ADULT = 15; const RENT_INCREASE_PER_PERIOD = 2; const RENT_MAX_UNPAID_DAYS = 6; const RENT_PERIOD_DAYS = 3;
        const LOW_ENERGY_THRESHOLD = 25;

        const CHORE_DATA = { clean_toys: { name: "Toy Cleaner", basePay: 5, energyCost: 5, durationFrames: 10*60, itemsToClean: 3, expGain: 8, happinessToll: -0.2, minigameType: 'click_scattered' }};
        const JOB_TIERS = {
            teen: [{ id: 'shelf_stocker', name: "Shelf Stocker", basePay: 10, energyCost: 10, smartnessMin: 0, expMin: 0, durationFrames: 12*60, itemsToStock: 5, expGain: 10, happinessToll: -0.5, promotionBaseChance: 0.1, promotionBonusPerTask: 0.02, promotionBonusPerSmartness: 0.001, promotionBonusPerExp: 0.0005, minigameType: 'click_fill_slots' }],
            adult: [
                { id: 'office_worker_entry', name: "Data Entry Clerk", basePay: 25, energyCost: 15, smartnessMin: 30, expMin: 0, durationFrames: 20*60, wordsToType: 3, expGain: 12, happinessToll: -1.0, promotionBaseChance: 0.15, promotionBonusPerTask: 0.015, promotionBonusPerSmartness: 0.002, promotionBonusPerExp: 0.0008, minigameType: 'typing' },
                { id: 'programmer_trainee', name: "Programmer Trainee", basePay: 45, energyCost: 20, smartnessMin: 50, expMin: 40, durationFrames: 25*60, sequencesToRemember: 4, sequenceMaxLength: 4, expGain: 18, happinessToll: -1.5, promotionBaseChance: 0.12, promotionBonusPerTask: 0.01, promotionBonusPerSmartness: 0.0025, promotionBonusPerExp: 0.001, minigameType: 'sequence_memory' },
                { id: 'junior_manager', name: "Junior Manager", basePay: 70, energyCost: 18, smartnessMin: 65, expMin: 75, durationFrames: 30*60, tasksToApprove: 5, expGain: 25, happinessToll: -2.0, promotionBaseChance: 0.1, promotionBonusPerTask: 0.008, promotionBonusPerSmartness: 0.003, promotionBonusPerExp: 0.0012, minigameType: 'timed_reaction_button' }
            ],
            senior: [ // MODIFIED SENIOR JOBS
                { id: 'senior_data_analyst', name: "Freelance Editor", basePay: 30, energyCost: 20, smartnessMin: 60, expMin: 70, durationFrames: 15*60, wordsToType: 5, expGain: 10, happinessToll: -1.8, promotionBaseChance: 0.03, promotionBonusPerTask: 0.003, promotionBonusPerSmartness: 0.001, promotionBonusPerExp: 0.0005, minigameType: 'typing' },
                { id: 'legacy_code_expert', name: "Archive Consultant", basePay: 50, energyCost: 25, smartnessMin: 70, expMin: 80, durationFrames: 20*60, sequencesToRemember: 5, sequenceMaxLength: 5, expGain: 15, happinessToll: -2.2, promotionBaseChance: 0.02, promotionBonusPerTask: 0.002, promotionBonusPerSmartness: 0.0015, promotionBonusPerExp: 0.0008, minigameType: 'sequence_memory' },
                { id: 'community_event_helper', name: "Event Coordinator", basePay: 40, energyCost: 15, smartnessMin: 50, expMin: 60, durationFrames: 25*60, tasksToApprove: 6, expGain: 12, happinessToll: -1.2, promotionBaseChance: 0.04, promotionBonusPerTask: 0.004, promotionBonusPerSmartness: 0.001, promotionBonusPerExp: 0.0006, minigameType: 'timed_reaction_button' }
            ]
        };
        const TYPING_CHALLENGE_WORDS = ["REPORT","CLIENT","MEETING","PROJECT","DEADLINE","SYSTEM","UPDATE","SOFTWARE","DATABASE","NETWORK","TASK","FILE","SAVE","CODE","WORK","INFO","ANALYSIS","STRATEGY","DOCUMENT","ARCHIVE","CONSULT"]; // Added some longer words
        const SEQUENCE_COLORS = ['#FF0000', '#00FF00', '#0000FF', '#FFFF00'];
        const SUITS = ["♥", "♦", "♣", "♠"]; // Hearts, Diamonds, Clubs, Spades
        const RANKS = ["2", "3", "4", "5", "6", "7", "8", "9", "T", "J", "Q", "K", "A"];


        const DAY_NIGHT_CYCLE_DURATION = AGE_SPEED * 1;
        const BACKGROUNDS = { egg: {sky:['#FFDEAD','#FFDEAD'],ground:['#D2B48C','#D2B48C']}, child: {sky:['#a0c0e0','#4682B4'],ground:['#70a070','#556B2F']}, teen: {sky:['#87CEEB','#2F4F4F'],ground:['#90EE90','#6B8E23']}, adult: {sky:['#6495ED','#191970'],ground:['#8FBC8F','#006400']}, senior: {sky:['#B0C4DE','#708090'],ground:['#A9A9A9','#696969']}};
        let gameTimeOfDay = 0;

        const C_SKIN='#FFDBAC',C_BLACK='#000000',C_WHITE='#FFFFFF',C_RED='#FF0000',C_GREEN='#00FF00',C_BLUE='#0000FF',C_YELLOW='#FFFF00',C_BROWN='#8B4513',C_GREY='#808080',C_DARK_GREY='#404040',C_EGG_SHELL='#F0E68C',C_TOY_RED='#FF6347',C_TOY_BLUE='#1E90FF',C_TOY_GREEN='#32CD32',C_SHELF='#A0522D',C_SHELF_EMPTY='#D2B48C',C_ITEM_BLUE='#6495ED';
        let david = {}; let ageInterval, statDecayInterval, gameLoopId, playtimeIntervalId;
        let currentAction = null, actionTimer = 0; let particleSystem = []; let currentMinigame = null;
        let isGamePaused = false; let lastTickTime = 0; let sessionStartTime = 0;

        const colorMap = [null,C_SKIN,C_BLACK,C_WHITE,C_RED,C_DARK_GREY,C_EGG_SHELL,C_TOY_RED,C_TOY_BLUE,C_TOY_GREEN,C_ITEM_BLUE,C_SHELF_EMPTY];
        const davidArt = { /* Condensed art */
            egg:{width:10,height:12,pixels:[[4,0,6],[5,0,6],[3,1,6],[4,1,6],[5,1,6],[6,1,6],[2,2,6],[3,2,6],[4,2,6],[5,2,6],[6,2,6],[7,2,6],[2,3,6],[3,3,6],[4,3,6],[5,3,6],[6,3,6],[7,3,6],[1,4,6],[2,4,6],[3,4,6],[4,4,6],[5,4,6],[6,4,6],[7,4,6],[8,4,6],[1,5,6],[2,5,6],[3,5,6],[4,5,6],[5,5,6],[6,5,6],[7,5,6],[8,5,6],[1,6,6],[2,6,6],[3,6,6],[4,6,6],[5,6,6],[6,6,6],[7,6,6],[8,6,6],[1,7,6],[2,7,6],[3,7,6],[4,7,6],[5,7,6],[6,7,6],[7,7,6],[8,7,6],[2,8,6],[3,8,6],[4,8,6],[5,8,6],[6,8,6],[7,8,6],[2,9,6],[3,9,6],[4,9,6],[5,9,6],[6,9,6],[7,9,6],[3,10,6],[4,10,6],[5,10,6],[6,10,6],[4,11,6],[5,11,6]]},
            child:{width:10,height:16,head:[[3,0,1],[4,0,1],[5,0,1],[6,0,1],[2,1,1],[3,1,1],[4,1,1],[5,1,1],[6,1,1],[7,1,1],[2,2,1],[3,2,1],[4,2,1],[5,2,1],[6,2,1],[7,2,1],[2,3,1],[3,3,1],[4,3,1],[5,3,1],[6,3,1],[7,3,1],[3,4,1],[4,4,1],[5,4,1],[6,4,1],[3,2,2],[6,2,2],[3,3,2],[4,3,2],[5,3,2],[6,3,2]],body:[[4,5,5],[5,5,5],[4,6,5],[5,6,5],[4,7,5],[5,7,5],[4,8,5],[5,8,5],[2,6,5],[3,6,5],[6,6,5],[7,6,5],[1,7,5],[8,7,5],[4,9,5],[3,10,5],[2,11,5],[5,9,5],[6,10,5],[7,11,5]],blinkFrame:{head:[[3,0,1],[4,0,1],[5,0,1],[6,0,1],[2,1,1],[3,1,1],[4,1,1],[5,1,1],[6,1,1],[7,1,1],[2,2,1],[3,2,1],[4,2,1],[5,2,1],[6,2,1],[7,2,1],[2,3,1],[3,3,1],[4,3,1],[5,3,1],[6,3,1],[7,3,1],[3,4,1],[4,4,1],[5,4,1],[6,4,1],[3,2,2],[4,2,2],[5,2,2],[6,2,2],[3,3,2],[4,3,2],[5,3,2],[6,3,2]],body:[[4,5,5],[5,5,5],[4,6,5],[5,6,5],[4,7,5],[5,7,5],[4,8,5],[5,8,5],[2,6,5],[3,6,5],[6,6,5],[7,6,5],[1,7,5],[8,7,5],[4,9,5],[3,10,5],[2,11,5],[5,9,5],[6,10,5],[7,11,5]]}},
            senior:{width:10,height:16,head:[[3,0,1],[4,0,1],[5,0,1],[6,0,1],[2,1,1],[3,1,1],[4,1,1],[5,1,1],[6,1,1],[7,1,1],[2,2,1],[3,2,1],[4,2,3],[5,2,3],[6,2,1],[7,2,1],[3,3,1],[4,3,1],[5,3,1],[6,3,1],[3,2,2],[6,2,2],[3,3,2],[4,3,2],[5,3,2]],body:[[4,5,5],[5,5,5],[4,6,5],[5,6,5],[3,7,5],[4,7,5],[2,6,5],[3,6,5],[6,6,5],[7,6,5],[8,7,5],[4,8,5],[3,9,5],[2,10,5],[5,8,5],[6,9,5],[7,10,5],[8,8,2],[8,9,2],[8,10,2]],blinkFrame:{head:[[3,0,1],[4,0,1],[5,0,1],[6,0,1],[2,1,1],[3,1,1],[4,1,1],[5,1,1],[6,1,1],[7,1,1],[2,2,1],[3,2,1],[4,2,2],[5,2,2],[6,2,1],[7,2,1],[3,3,1],[4,3,1],[5,3,1],[6,3,1],[3,2,2],[6,2,2],[3,3,2],[4,3,2],[5,3,2]],body:[[4,5,5],[5,5,5],[4,6,5],[5,6,5],[3,7,5],[4,7,5],[2,6,5],[3,6,5],[6,6,5],[7,6,5],[8,7,5],[4,8,5],[3,9,5],[2,10,5],[5,8,5],[6,9,5],[7,10,5],[8,8,2],[8,9,2],[8,10,2]]}}, // Senior blink frame
            apple:{width:6,height:6,pixels:[[2,0,4],[3,0,4],[1,1,4],[2,1,4],[3,1,4],[4,1,4],[1,2,4],[2,2,4],[3,2,4],[4,2,4],[1,3,4],[2,3,4],[3,3,4],[4,3,4],[2,4,4],[3,4,4],[2,1,2]]},soap:{width:6,height:4,pixels:[[1,0,3],[2,0,3],[3,0,3],[4,0,3],[0,1,3],[1,1,3],[2,1,3],[3,1,3],[4,1,3],[5,1,3],[0,2,3],[1,2,3],[2,2,3],[3,2,3],[4,2,3],[5,2,3],[1,3,3],[2,3,3],[3,3,3],[4,3,3]]},ball:{width:5,height:5,pixels:[[2,0,4],[1,1,4],[2,1,4],[3,1,4],[0,2,4],[1,2,4],[2,2,4],[3,2,4],[4,2,4],[1,3,4],[2,3,4],[3,3,4],[2,4,4]]},book:{width:7,height:5,pixels:[[0,0,2],[1,0,2],[2,0,2],[3,0,2],[4,0,2],[5,0,2],[6,0,2],[0,1,2],[1,1,3],[2,1,3],[3,1,2],[4,1,3],[5,1,3],[6,1,2],[0,2,2],[1,2,3],[2,2,3],[3,2,2],[4,2,3],[5,2,3],[6,2,2],[0,3,2],[1,3,3],[2,3,3],[3,3,2],[4,3,3],[5,3,3],[6,3,2],[0,4,2],[1,4,2],[2,4,2],[3,4,2],[4,4,2],[5,4,2],[6,4,2]]},zzz:{width:5,height:3,pixels:[[0,0,2],[1,0,2],[3,0,2],[4,0,2],[2,1,2],[0,2,2],[1,2,2],[3,2,2],[4,2,2]]},tombstone:{width:10,height:12,pixels:[[3,0,5],[4,0,5],[5,0,5],[6,0,5],[2,1,5],[3,1,5],[4,1,5],[5,1,5],[6,1,5],[7,1,5],[2,2,5],[3,2,5],[4,2,5],[5,2,5],[6,2,5],[7,2,5],[2,3,5],[3,3,5],[4,3,5],[5,3,5],[6,3,5],[7,3,5],[2,4,5],[3,4,5],[4,4,5],[5,4,5],[6,4,5],[7,4,5],[2,5,5],[3,5,5],[4,5,5],[5,5,5],[6,5,5],[7,5,5],[2,6,5],[3,6,5],[4,6,5],[5,6,5],[6,6,5],[7,6,5],[2,7,5],[3,7,5],[4,7,5],[5,7,5],[6,7,5],[7,7,5],[2,8,5],[3,8,5],[4,8,5],[5,8,5],[6,8,5],[7,8,5],[1,9,5],[2,9,5],[3,9,5],[4,9,5],[5,9,5],[6,9,5],[7,9,5],[8,9,5],[1,10,5],[2,10,5],[3,10,5],[4,10,5],[5,10,5],[6,10,5],[7,10,5],[8,10,5],[1,11,5],[2,11,5],[3,11,5],[4,11,5],[5,11,5],[6,11,5],[7,11,5],[8,11,5]]},
            toy_block:{width:3,height:3,pixels:[[0,0,7],[1,0,7],[2,0,7],[0,1,7],[1,1,7],[2,1,7],[0,2,7],[1,2,7],[2,2,7]]},
            shelf_item_art:{width:4,height:3,pixels:[[0,0,10],[1,0,10],[2,0,10],[3,0,10],[0,1,10],[1,1,10],[2,1,10],[3,1,10],[0,2,10],[1,2,10],[2,2,10],[3,2,10]]}
        };
        // Blackjack DOM elements
        const blackjackDealerHandDisplay = document.getElementById('blackjackDealerHand');
        const blackjackPlayerHandDisplay = document.getElementById('blackjackPlayerHand');
        const blackjackDealerScoreDisplay = document.getElementById('blackjackDealerScore');
        const blackjackPlayerScoreDisplay = document.getElementById('blackjackPlayerScore');
        const blackjackMessageDisplay = document.getElementById('blackjackMessage');
        const blackjackBetInput = document.getElementById('blackjackBetInput');
        const blackjackDealButton = document.getElementById('blackjackDealButton');
        const blackjackHitButton = document.getElementById('blackjackHitButton');
        const blackjackStandButton = document.getElementById('blackjackStandButton');
        const blackjackCloseButton = document.getElementById('blackjackCloseButton');
        const blackjackBetControls = document.getElementById('blackjackBetControls');
        const blackjackActionControls = document.getElementById('blackjackActionControls');


        function initDavid(){david={stage:'egg',age:0,evolutionAges:{child:1,teen:10,adult:20,senior:65},stats:{happiness:80,hunger:80,cleanliness:80,energy:90,smartness:0,experience:0},maxStats:{happiness:100,hunger:100,cleanliness:100,energy:100,smartness:100,experience:100},isSleeping:false,isDead:false,posX:canvas.width/2,posY:canvas.height-(16*PIXEL_SCALE)-20,animFrame:0,blinkRate:150,isBlinking:false,lastBlinkTime:0,hungerDeathWarnTicks:0,sadDeathWarnTicks:0,money:STARTING_MONEY,job:null,rent:0,daysRentUnpaid:0,daysSincePromotionAttempt:0,};currentMinigame=null;['typingMinigameOverlay','programmerMinigameOverlay','managerMinigameOverlay','jobChoiceOverlay', 'blackjackOverlay'].forEach(id=>document.getElementById(id).style.display='none');canvasMinigameInfo.style.display='none';gameTimeOfDay=0;updateUI();document.getElementById('gameOverScreen').style.display='none';enableControls();displayMessage("A new egg has appeared!");isGamePaused=false;sessionStartTime=performance.now();lastTickTime=sessionStartTime;}
        function drawPixelArt(artData,x,y,overrideColorMap=null){const cM=overrideColorMap||colorMap;if(artData.pixels){artData.pixels.forEach(p=>{if(p[2]>0&&cM[p[2]]){ctx.fillStyle=cM[p[2]];ctx.fillRect((x+p[0])*PIXEL_SCALE,(y+p[1])*PIXEL_SCALE,PIXEL_SCALE,PIXEL_SCALE);}});}else if(artData.head&&artData.body){let h=artData.head;let bF = artData.blinkFrame; if (david.stage === 'senior' && davidArt.senior.blinkFrame) bF = davidArt.senior.blinkFrame; if(david.stage!=='egg'&&david.animFrame%david.blinkRate<5&&!david.isBlinking){david.isBlinking=true;david.lastBlinkTime=david.animFrame;}if(david.isBlinking && bF){h=bF.head;if(david.animFrame>david.lastBlinkTime+5)david.isBlinking=false;}h.forEach(p=>{if(p[2]>0&&cM[p[2]]){ctx.fillStyle=cM[p[2]];ctx.fillRect((x+p[0])*PIXEL_SCALE,(y+p[1])*PIXEL_SCALE,PIXEL_SCALE,PIXEL_SCALE);}});artData.body.forEach(p=>{if(p[2]>0&&cM[p[2]]){ctx.fillStyle=cM[p[2]];ctx.fillRect((x+p[0])*PIXEL_SCALE,(y+p[1])*PIXEL_SCALE,PIXEL_SCALE,PIXEL_SCALE);}});}}
        function drawDavid(){let a;let oX=0;let oY=david.posY/PIXEL_SCALE;switch(david.stage){case'egg':a=davidArt.egg;oX=(canvas.width/PIXEL_SCALE-a.width)/2;oY=(canvas.height/PIXEL_SCALE-a.height)/2+5;break;case'child':case'teen':case'adult':a=davidArt.child;oX=(canvas.width/PIXEL_SCALE-(a?a.width:davidArt.child.width))/2;break;case'senior':a=davidArt.senior;oX=(canvas.width/PIXEL_SCALE-(a?a.width:davidArt.senior.width))/2;break;default:return;}if(david.isDead){a=davidArt.tombstone;oX=(canvas.width/PIXEL_SCALE-a.width)/2;oY=(canvas.height/PIXEL_SCALE-a.height)/2+2;drawPixelArt(a,oX,oY);return;}drawPixelArt(a,oX,oY);if(david.isSleeping){const zA=davidArt.zzz;const zX=oX+(a?(a.width||davidArt.child.width):davidArt.child.width)-2+Math.sin(david.animFrame/10)*2;const zY=oY-(zA?zA.height:0)+Math.cos(david.animFrame/8)*1;drawPixelArt(zA,zX,zY);}}
        function drawActionItem(){if(!currentAction||actionTimer<=0)return;let iA;let iX=(canvas.width/PIXEL_SCALE-6)/2;let iY=david.posY/PIXEL_SCALE-10;switch(currentAction.type){case'feed':iA=davidArt.apple;break;case'clean':iA=davidArt.soap;iY-=2;break;case'play':iA=davidArt.ball;iX=david.posX/PIXEL_SCALE+10+Math.sin(actionTimer/10)*5;iY=david.posY/PIXEL_SCALE+5+Math.cos(actionTimer/10)*5;break;case'study':iA=davidArt.book;break;default:return;}if(iA)drawPixelArt(iA,iX,iY);}
        function drawParticles(){for(let i=particleSystem.length-1;i>=0;i--){let p=particleSystem[i];p.x+=p.vx;p.y+=p.vy;p.life--;if(p.life<=0)particleSystem.splice(i,1);else{ctx.fillStyle=p.color;ctx.fillRect(p.x*PIXEL_SCALE,p.y*PIXEL_SCALE,PIXEL_SCALE,PIXEL_SCALE);}}}
        function createParticles(n,x,y,c,t='burst'){for(let i=0;i<n;i++){particleSystem.push({x:x/PIXEL_SCALE,y:y/PIXEL_SCALE,vx:(Math.random()-0.5)*(t==='bubbles'?0.2:1),vy:(Math.random()-0.5)*(t==='bubbles'?0.5:1)-(t==='bubbles'?0.3:0),life:20+Math.random()*20,color:t==='bubbles'?`rgba(200,220,255,${Math.random()*0.5+0.3})`:c});}}
        function drawMinigame(){if(!currentMinigame)return;ctx.fillStyle='#b0b0b0';ctx.fillRect(0,0,canvas.width,canvas.height);canvas.style.cursor='pointer';const jobData=currentMinigame.jobDataRef;if(currentMinigame.type==='click_scattered'){currentMinigame.state.items.forEach(i=>{if(!i.cleaned){drawPixelArt(davidArt.toy_block,i.x,i.y,[null,null,null,null,null,null,null,i.color]);}});canvasMinigameInfo.innerHTML=`Clean Toys! ${currentMinigame.state.cleanedCount}/${jobData.itemsToClean} | Time: ${Math.ceil(currentMinigame.state.timeLeftFrames/60)}s`;}else if(currentMinigame.type==='click_fill_slots'){const sPH=10*PIXEL_SCALE;const sYPPx=[15*PIXEL_SCALE,30*PIXEL_SCALE,45*PIXEL_SCALE];sYPPx.forEach(yP=>{ctx.fillStyle=C_SHELF;ctx.fillRect(5*PIXEL_SCALE,yP,(canvas.width/PIXEL_SCALE-10)*PIXEL_SCALE,sPH);});currentMinigame.state.shelfSpots.forEach(s=>{ctx.fillStyle=s.stocked?C_ITEM_BLUE:C_SHELF_EMPTY;ctx.fillRect(s.x*PIXEL_SCALE,s.y*PIXEL_SCALE,davidArt.shelf_item_art.width*PIXEL_SCALE,davidArt.shelf_item_art.height*PIXEL_SCALE);if(s.stocked){drawPixelArt(davidArt.shelf_item_art,s.x,s.y);}});canvasMinigameInfo.innerHTML=`Stock Shelves! ${currentMinigame.state.stockedCount}/${jobData.itemsToStock} | Time: ${Math.ceil(currentMinigame.state.timeLeftFrames/60)}s`;}else if(currentMinigame.type==='sequence_memory'){const bS=8*PIXEL_SCALE;const g=2*PIXEL_SCALE;const tW=currentMinigame.state.sequenceBlocks.length*(bS+g)-g;let sX=(canvas.width-tW)/2;currentMinigame.state.sequenceBlocks.forEach((b,idx)=>{const blockDiv=document.getElementById('sequenceDisplay').children[idx];if(blockDiv)blockDiv.style.backgroundColor=b.lit?b.color:C_DARK_GREY;});canvasMinigameInfo.innerHTML=`Programmer: Seq ${currentMinigame.state.currentSequenceNum+1}/${jobData.sequencesToRemember}. ${currentMinigame.state.playerSequence.length}/${currentMinigame.state.currentCorrectSequence.length}. Time: ${Math.ceil(currentMinigame.state.timeLeftFrames/60)}s`;}}
        
        function updateMinigame(){if(!currentMinigame || currentMinigame.type === 'blackjack')return; currentMinigame.state.timeLeftFrames--; const jobData = currentMinigame.jobDataRef; if(currentMinigame.type==='click_scattered'){if(currentMinigame.state.timeLeftFrames<=0){endMinigame(currentMinigame.state.cleanedCount>=jobData.itemsToClean);}}else if(currentMinigame.type==='click_fill_slots'){if(currentMinigame.state.timeLeftFrames<=0){endMinigame(currentMinigame.state.stockedCount>=jobData.itemsToStock);}}else if(currentMinigame.type==='typing'){document.getElementById('typingTimeLeft').textContent=Math.ceil(currentMinigame.state.timeLeftFrames/60);if(currentMinigame.state.timeLeftFrames<=0){endMinigame(currentMinigame.state.wordsTyped>=jobData.wordsToType);}}else if(currentMinigame.type==='sequence_memory'){if(currentMinigame.state.showingSequence){currentMinigame.state.showTimer--;if(currentMinigame.state.showTimer<=0){if(currentMinigame.state.showIndex<currentMinigame.state.currentCorrectSequence.length){const blockToLight=currentMinigame.state.sequenceBlocks[currentMinigame.state.currentCorrectSequence[currentMinigame.state.showIndex]];blockToLight.lit=true;const blockDivToUpdate=document.getElementById('sequenceDisplay').children[currentMinigame.state.currentCorrectSequence[currentMinigame.state.showIndex]];if(blockDivToUpdate)blockDivToUpdate.style.backgroundColor=blockToLight.color;currentMinigame.state.showTimer=30;setTimeout(()=>{if(currentMinigame&¤tMinigame.type==='sequence_memory'&¤tMinigame.state.sequenceBlocks[currentMinigame.state.currentCorrectSequence[currentMinigame.state.showIndex-1]]){currentMinigame.state.sequenceBlocks[currentMinigame.state.currentCorrectSequence[currentMinigame.state.showIndex-1]].lit=false;const prevBlockDiv=document.getElementById('sequenceDisplay').children[currentMinigame.state.currentCorrectSequence[currentMinigame.state.showIndex-1]];if(prevBlockDiv)prevBlockDiv.style.backgroundColor=C_DARK_GREY;}},20*16);currentMinigame.state.showIndex++;}else{currentMinigame.state.showingSequence=false;currentMinigame.state.playerTurn=true;displayMessage("Your turn!");}}}if(currentMinigame.state.timeLeftFrames<=0){endMinigame(currentMinigame.state.sequencesCorrect>=jobData.sequencesToRemember);}}else if(currentMinigame.type==='timed_reaction_button'){document.getElementById('managerTimeLeft').textContent=Math.ceil(currentMinigame.state.timeLeftFrames/60);if(currentMinigame.state.taskActive&¤tMinigame.state.taskTimer>0){currentMinigame.state.taskTimer--;if(currentMinigame.state.taskTimer<=0){currentMinigame.state.taskActive=false;document.getElementById('managerTaskArea').innerHTML="";currentMinigame.state.nextTaskDelay=Math.random()*120+60;currentMinigame.state.missedTasks++;if(currentMinigame.state.missedTasks>1){endMinigame(false);return;}}}else if(!currentMinigame.state.taskActive&¤tMinigame.state.nextTaskDelay>0){currentMinigame.state.nextTaskDelay--;if(currentMinigame.state.nextTaskDelay<=0&¤tMinigame.state.tasksShown<jobData.tasksToApprove){currentMinigame.state.taskActive=true;currentMinigame.state.taskTimer=90;const aB=document.createElement('button');aB.textContent="APPROVE";aB.className="minigame-button";aB.onclick=()=>{if(currentMinigame&¤tMinigame.state.taskActive){currentMinigame.state.tasksDone++;document.getElementById('managerTasksDone').textContent=currentMinigame.state.tasksDone;currentMinigame.state.taskActive=false;document.getElementById('managerTaskArea').innerHTML="";currentMinigame.state.nextTaskDelay=Math.random()*120+60;if(currentMinigame.state.tasksDone>=jobData.tasksToApprove){endMinigame(true);}}};document.getElementById('managerTaskArea').innerHTML="";document.getElementById('managerTaskArea').appendChild(aB);currentMinigame.state.tasksShown++;}}if(currentMinigame.state.timeLeftFrames<=0){endMinigame(currentMinigame.state.tasksDone>=jobData.tasksToApprove);}}}
        function startNewSequenceProgrammer(){if(!currentMinigame||currentMinigame.type!=='sequence_memory')return;currentMinigame.state.currentCorrectSequence=[];const len=Math.min(currentMinigame.jobDataRef.sequenceMaxLength,2+currentMinigame.state.currentSequenceNum);for(let i=0;i<len;i++){currentMinigame.state.currentCorrectSequence.push(Math.floor(Math.random()*currentMinigame.state.sequenceBlocks.length));}currentMinigame.state.playerSequence=[];currentMinigame.state.showingSequence=true;currentMinigame.state.playerTurn=false;currentMinigame.state.showIndex=0;currentMinigame.state.showTimer=60;displayMessage(`Watch sequence ${currentMinigame.state.currentSequenceNum+1}...`);}
        
        function startMinigame(jobDataOrType, options = {}){
            if(currentAction||david.isSleeping||currentMinigame)return;
            disableControls(true);
            
            if (typeof jobDataOrType === 'string' && jobDataOrType === 'blackjack') {
                currentMinigame = {
                    type: 'blackjack',
                    state: {
                        deck: [], playerHand: [], dealerHand: [],
                        playerScore: 0, dealerScore: 0,
                        dealerHiddenCard: null, currentBet: 0,
                        phase: 'betting' // betting, player_turn, dealer_turn, round_over
                    }
                };
                blackjackBetInput.value = Math.max(1, Math.min(10, david.money)); // Default bet
                blackjackBetInput.max = david.money;
                blackjackOverlay.style.display = 'flex';
                blackjackMessageDisplay.textContent = "Place your bet and click Deal.";
                blackjackBetControls.style.display = 'flex';
                blackjackActionControls.style.display = 'none';
                updateBlackjackUIDisplay(); // Clear previous hands if any
                updateUI();
                return;
            }

            const data = jobDataOrType; // Assuming it's jobDataFull object
            if(david.stats.energy<data.energyCost){displayMessage(`Tired for ${data.name}.`);enableControls();return;}
            currentMinigame={type:data.minigameType,pay:data.basePay,energyCost:data.energyCost,expGain:data.expGain,state:{timeLeftFrames:data.durationFrames},jobDataRef:data};david.stats.energy-=data.energyCost;if(data.minigameType==='click_scattered'){currentMinigame.state.items=[];currentMinigame.state.cleanedCount=0;for(let i=0;i<data.itemsToClean;i++){const tC=[C_TOY_RED,C_TOY_BLUE,C_TOY_GREEN];currentMinigame.state.items.push({x:Math.floor(Math.random()*(canvas.width/PIXEL_SCALE-davidArt.toy_block.width-10))+5,y:Math.floor(Math.random()*(canvas.height/PIXEL_SCALE-davidArt.toy_block.height-30))+15,cleaned:false,color:tC[Math.floor(Math.random()*tC.length)]});}canvasMinigameInfo.style.display='block';displayMessage(`Chore: ${data.name}!`);}else if(data.minigameType==='click_fill_slots'){currentMinigame.state.shelfSpots=[];currentMinigame.state.stockedCount=0;const sW=davidArt.shelf_item_art.width+2;const iPR=Math.floor((canvas.width/PIXEL_SCALE-10)/sW);const yPSSM=[17,32,47];for(let r=0;r<yPSSM.length&¤tMinigame.state.shelfSpots.length<data.itemsToStock;r++){for(let c=0;c<iPR&¤tMinigame.state.shelfSpots.length<data.itemsToStock;c++){currentMinigame.state.shelfSpots.push({x:7+c*sW,y:yPSSM[r],stocked:false});}}canvasMinigameInfo.style.display='block';displayMessage(`Job: ${data.name}!`);}else if(data.minigameType==='typing'){currentMinigame.state.currentWordIndex=0;currentMinigame.state.wordsTyped=0;currentMinigame.state.challengeWords=TYPING_CHALLENGE_WORDS.sort(()=>0.5-Math.random()).slice(0,data.wordsToType);document.getElementById('typingChallengeText').textContent=currentMinigame.state.challengeWords[0];document.getElementById('typingInput').value='';document.getElementById('typingWordsCompleted').textContent=0;document.getElementById('typingWordsTotal').textContent=data.wordsToType;document.getElementById('typingMinigameOverlay').style.display='flex';document.getElementById('typingTimeLeft').textContent=Math.ceil(currentMinigame.state.timeLeftFrames/60);document.getElementById('typingInput').focus();displayMessage(`Job: ${data.name}!`);}else if(data.minigameType==='sequence_memory'){document.getElementById('programmerMinigameOverlay').style.display='flex';currentMinigame.state.sequenceBlocks=[];const sD=document.getElementById('sequenceDisplay');sD.innerHTML='';for(let i=0;i<SEQUENCE_COLORS.length;i++){currentMinigame.state.sequenceBlocks.push({color:SEQUENCE_COLORS[i],lit:false,id:i});const bD=document.createElement('div');bD.className='minigame-sequence-block';bD.style.backgroundColor=C_DARK_GREY;bD.onclick=()=>handleProgrammerBlockClick(i);sD.appendChild(bD);}currentMinigame.state.currentSequenceNum=0;currentMinigame.state.sequencesCorrect=0;document.getElementById('programmerScore').textContent=0;document.getElementById('programmerTargetScore').textContent=data.sequencesToRemember;document.getElementById('programmerTimeLeft').textContent=Math.ceil(currentMinigame.state.timeLeftFrames/60);startNewSequenceProgrammer();displayMessage(`Job: ${data.name}!`);}else if(data.minigameType==='timed_reaction_button'){document.getElementById('managerMinigameOverlay').style.display='flex';currentMinigame.state.tasksDone=0;currentMinigame.state.tasksShown=0;currentMinigame.state.missedTasks=0;currentMinigame.state.taskActive=false;currentMinigame.state.taskTimer=0;currentMinigame.state.nextTaskDelay=60;document.getElementById('managerTasksDone').textContent=0;document.getElementById('managerTasksTotal').textContent=data.tasksToApprove;document.getElementById('managerTimeLeft').textContent=Math.ceil(currentMinigame.state.timeLeftFrames/60);document.getElementById('managerTaskArea').innerHTML="Get Ready...";displayMessage(`Job: ${data.name}!`);
            // Removed autocompletion for 'choice_scenario' and 'simple_quiz' as senior jobs use other types now.
            // If those types were to be used by seniors, this is where the no-autocomplete logic for seniors would go.
            }updateUI();
        }

        function handleProgrammerBlockClick(index){if(!currentMinigame||currentMinigame.type!=='sequence_memory'||!currentMinigame.state.playerTurn)return;currentMinigame.state.playerSequence.push(index);const cBD=document.getElementById('sequenceDisplay').children[index];cBD.style.backgroundColor=currentMinigame.state.sequenceBlocks[index].color;setTimeout(()=>{cBD.style.backgroundColor=C_DARK_GREY;},200);const cS=currentMinigame.state.currentCorrectSequence;const pS=currentMinigame.state.playerSequence;if(pS[pS.length-1]!==cS[pS.length-1]){displayMessage("Wrong sequence!");startNewSequenceProgrammer();return;}if(pS.length===cS.length){currentMinigame.state.sequencesCorrect++;currentMinigame.state.currentSequenceNum++;document.getElementById('programmerScore').textContent=currentMinigame.state.sequencesCorrect;if(currentMinigame.state.sequencesCorrect>=currentMinigame.jobDataRef.sequencesToRemember){endMinigame(true);}else{displayMessage("Correct! Next...");startNewSequenceProgrammer();}}}
        
        function endMinigame(success){
            if(!currentMinigame)return;
            const minigameType = currentMinigame.type;

            if (minigameType === 'blackjack') { // Blackjack has its own closing logic
                closeBlackjackTable();
                return;
            }
            // For other minigames:
            const jobData=currentMinigame.jobDataRef;
            const wasComplex=jobData.minigameType==='typing'||jobData.minigameType==='sequence_memory'||jobData.minigameType==='timed_reaction_button';
            canvas.style.cursor='default';canvasMinigameInfo.style.display='none';
            ['typingMinigameOverlay','programmerMinigameOverlay','managerMinigameOverlay'].forEach(id=>document.getElementById(id).style.display='none');
            if(success){
                david.money+=currentMinigame.pay;david.stats.experience=Math.min(david.maxStats.experience,david.stats.experience+currentMinigame.expGain);
                david.stats.happiness=Math.max(0,david.stats.happiness+jobData.happinessToll);
                if(david.job){david.job.tasksToday++;}
                displayMessage(`Task done! +$${currentMinigame.pay}, +${currentMinigame.expGain} EXP. (Hap ${jobData.happinessToll>=0?'+':''}${jobData.happinessToll})`);
                createParticles(30,canvas.width/2,david.posY,C_GREEN,'burst');
            }else{
                displayMessage("Task failed. No reward.");
                david.stats.happiness=Math.max(0,david.stats.happiness-(wasComplex?10:5) * (david.stage === 'senior' ? 1.5 : 1)); // Higher happiness penalty for seniors on fail
            }
            currentMinigame=null;enableControls();updateUI();
        }

        canvas.addEventListener('click',(event)=>{if(!currentMinigame)return;const r=canvas.getBoundingClientRect();const cX=(event.clientX-r.left)/PIXEL_SCALE;const cY=(event.clientY-r.top)/PIXEL_SCALE;const jobData=currentMinigame.jobDataRef;if(currentMinigame.type==='click_scattered'){currentMinigame.state.items.forEach(i=>{if(!i.cleaned&&cX>=i.x&&cX<=i.x+davidArt.toy_block.width&&cY>=i.y&&cY<=i.y+davidArt.toy_block.height){i.cleaned=true;currentMinigame.state.cleanedCount++;createParticles(5,i.x*PIXEL_SCALE,i.y*PIXEL_SCALE,C_YELLOW);if(currentMinigame.state.cleanedCount>=jobData.itemsToClean){endMinigame(true);}}});}else if(currentMinigame.type==='click_fill_slots'){currentMinigame.state.shelfSpots.forEach(s=>{if(!s.stocked&&cX>=s.x&&cX<=s.x+davidArt.shelf_item_art.width&&cY>=s.y&&cY<=s.y+davidArt.shelf_item_art.height){s.stocked=true;currentMinigame.state.stockedCount++;createParticles(5,s.x*PIXEL_SCALE,s.y*PIXEL_SCALE,C_YELLOW);if(currentMinigame.state.stockedCount>=jobData.itemsToStock){endMinigame(true);}}});}});
        document.getElementById('typingInput').addEventListener('input',(event)=>{if(currentMinigame&¤tMinigame.type==='typing'){const tV=event.target.value.toUpperCase();const cCW=currentMinigame.state.challengeWords[currentMinigame.state.currentWordIndex];const jobData=currentMinigame.jobDataRef;if(tV===cCW){currentMinigame.state.wordsTyped++;currentMinigame.state.currentWordIndex++;document.getElementById('typingWordsCompleted').textContent=currentMinigame.state.wordsTyped;event.target.value='';if(currentMinigame.state.wordsTyped>=jobData.wordsToType){endMinigame(true);}else{document.getElementById('typingChallengeText').textContent=currentMinigame.state.challengeWords[currentMinigame.state.currentWordIndex];displayMessage(`Correct! Next...`);}}}});
        
        function gameLoop(currentTime){if(isGamePaused&&!david.isDead){gameLoopId=requestAnimationFrame(gameLoop);return;}if(david.isDead){draw();return;}const deltaTime=currentTime-lastTickTime;lastTickTime=currentTime;if(!isGamePaused){gameTimeOfDay=(gameTimeOfDay+deltaTime)%DAY_NIGHT_CYCLE_DURATION;}if(actionTimer>0){actionTimer--;if(actionTimer===0)finishAction();}if(currentMinigame && currentMinigame.type !== 'blackjack'){updateMinigame();}draw();david.animFrame++;gameLoopId=requestAnimationFrame(gameLoop);}
        
        function processStatDecay(){
            if(isGamePaused||david.isDead)return;
            const timeProgress=gameTimeOfDay/DAY_NIGHT_CYCLE_DURATION;
            
            let baseEnergyDecayRate=2;
            if(timeProgress>0.7||timeProgress<0.25) baseEnergyDecayRate=2.5;

            let hungerDecay = 1.5;
            let cleanlinessDecay = 1.0;
            let currentEnergyDecayRate = baseEnergyDecayRate;
            let smartnessDecay = (david.stage === 'adult' || david.stage === 'senior') ? 0.15 : 0;
            // Experience decay when not working, slightly less if senior worked but more if not.
            let experienceDecay = 0;
            if (david.stage === 'adult' || david.stage === 'senior') {
                if (!david.job || david.job.tasksToday === 0) {
                    experienceDecay = david.stage === 'senior' ? 0.6 : 0.25;
                } else if (david.stage === 'senior' && david.job.tasksToday > 0) {
                    experienceDecay = 0.3; // Still decay some experience for seniors even if they worked
                }
            }
            
            let happinessDecayFromLowStats = 0;
            let seniorMultiplier = david.stage === 'senior' ? 2.0 : 1.0; // Senior stats decay faster
            let seniorHappinessMultiplier = david.stage === 'senior' ? 1.5 : 1.0; // Happiness penalties harsher for seniors

            if (david.stage === 'senior') {
                hungerDecay = 3.0; 
                cleanlinessDecay = 2.0; 
                currentEnergyDecayRate *= 1.8; 
                smartnessDecay = 0.5; 
            }

            if(!david.isSleeping){
                if(david.stats.hunger > 0) david.stats.hunger -= hungerDecay;
                else happinessDecayFromLowStats += 0.5 * seniorHappinessMultiplier;

                if(david.stats.cleanliness > 0) david.stats.cleanliness -= cleanlinessDecay;
                else happinessDecayFromLowStats += 0.3 * seniorHappinessMultiplier;

                if(david.stats.energy > 0){
                    david.stats.energy -= currentEnergyDecayRate;
                    if(david.stats.energy < LOW_ENERGY_THRESHOLD){
                        const scaledHappinessDecay = (LOW_ENERGY_THRESHOLD - david.stats.energy) * 0.05;
                        happinessDecayFromLowStats += scaledHappinessDecay * seniorHappinessMultiplier;
                    }
                } else {
                    happinessDecayFromLowStats += 1.0 * seniorHappinessMultiplier;
                }
                if(david.stats.happiness < 30) happinessDecayFromLowStats += 0.5 * seniorHappinessMultiplier;
                
                david.stats.happiness -= happinessDecayFromLowStats;

                if(david.stats.smartness > 0) david.stats.smartness -= smartnessDecay;
                if(david.stats.experience > 0) david.stats.experience -= experienceDecay;

            } else { // isSleeping
                let energyGain = 10;
                if(timeProgress > 0.7 || timeProgress < 0.25) energyGain = 12;
                let sleepHungerDecay = 0.5;
                let sleepCleanlinessDecay = 0.2;

                if (david.stage === 'senior') {
                    energyGain *= 0.6; // Sleep is much less restorative
                    sleepHungerDecay *= 2.5; // Get hungrier/dirtier faster even when sleeping
                    sleepCleanlinessDecay *= 2.0;
                }
                if(david.stats.energy < david.maxStats.energy) david.stats.energy += energyGain;
                else david.stats.energy = david.maxStats.energy; // Cap at max
                
                david.stats.hunger -= sleepHungerDecay;
                david.stats.cleanliness -= sleepCleanlinessDecay;
                
                if(david.stats.energy >= david.maxStats.energy){
                    toggleSleep();
                    displayMessage("Rested (as much as possible)!");
                }
            }
            for(let s in david.stats){if(david.stats[s]<0)david.stats[s]=0;if(david.stats[s]>david.maxStats[s])david.stats[s]=david.maxStats[s];}
            checkEvolution();checkDeath();updateUI();
        }

        function updateAge(){if(isGamePaused||david.isDead)return;if(david.isSleeping&&(david.stage==='adult'||david.stage==='senior')&&david.stats.energy>=david.maxStats.energy){}else{david.age++;if(david.age%RENT_PERIOD_DAYS===0&&(david.stage==='adult'||david.stage==='senior')){if(david.rent===0)david.rent=RENT_BASE_ADULT * (david.stage === 'senior' ? 1.5 : 1); // Higher base rent for seniors
            else david.rent+=RENT_INCREASE_PER_PERIOD * (david.stage === 'senior' ? 1.5 : 1);if(david.money>=david.rent){david.money-=david.rent;david.daysRentUnpaid=0;displayMessage(`Paid rent: $${david.rent}.`);}else{david.daysRentUnpaid+=RENT_PERIOD_DAYS;displayMessage(`Rent due $${david.rent}! ($${david.money})`);david.stats.happiness=Math.max(0,david.stats.happiness-20*(david.daysRentUnpaid/RENT_PERIOD_DAYS));if(david.daysRentUnpaid>=RENT_MAX_UNPAID_DAYS){david.isDead=true;gameOver(`Evicted! Lived ${david.age} days.`);return;}}}else if(david.stage!=='adult'&&david.stage!=='senior'){david.rent=0;david.daysRentUnpaid=0;}}if(david.job){david.job.tasksYesterday=david.job.tasksToday;david.job.tasksToday=0;}if(david.daysSincePromotionAttempt>0)david.daysSincePromotionAttempt--;document.getElementById('ageDisplay').textContent=`Age: ${david.age} days (${david.stage})`;
            if(david.stage==='senior'){ // Daily decay for seniors (on top of processStatDecay)
                david.stats.energy -= (2.5 + david.age * 0.02); // Increased daily energy loss
                david.stats.happiness -= (1.5 + david.age * 0.01); // Increased daily happiness loss
                david.stats.smartness = Math.max(0, david.stats.smartness - (0.5 + david.age * 0.003)); // Increased daily smartness loss
                david.stats.experience = Math.max(0, david.stats.experience - (0.6 + david.age * 0.003)); // Increased daily experience loss
                RENT_INCREASE_PER_PERIOD += 0.25; // Rent increases faster for seniors
            }
            checkEvolution();updateUI();
        }
        
        function checkEvolution(){let e=false;if(david.stage==='egg'&&david.age>=david.evolutionAges.child){evolveTo('child');e=true;}else if(david.stage==='child'&&david.age>=david.evolutionAges.teen){if(david.stats.smartness<15){displayMessage("Smarter for teen!");david.age=david.evolutionAges.teen-1;return;}evolveTo('teen');e=true;}else if(david.stage==='teen'&&david.age>=david.evolutionAges.adult){if(david.stats.smartness<40){displayMessage("Smarter for adult!");david.age=david.evolutionAges.adult-1;return;}evolveTo('adult');e=true;}else if(david.stage==='adult'&&david.age>=david.evolutionAges.senior){evolveTo('senior');e=true;}if(e){if(david.stage==='child'){david.job={type:'chore',...CHORE_DATA.clean_toys,tasksToday:0,tasksYesterday:0,data:CHORE_DATA.clean_toys};}else if(david.stage==='teen'){const jobData=JOB_TIERS.teen[0];david.job={type:'part-time',...jobData,tasksToday:0,tasksYesterday:0,data:jobData};}else if(david.stage==='adult'){const jobData=JOB_TIERS.adult[0];david.job={type:'full-time',...jobData,tasksToday:0,tasksYesterday:0,data:jobData};}else if(david.stage==='senior'){const jobData=JOB_TIERS.senior[0];david.job={type:'part-time',...jobData,tasksToday:0,tasksYesterday:0,data:jobData};displayMessage("David is now a senior. Life is harder, but new job options are available.");}david.stats.experience=0;updateUI();}}
        function evolveTo(nS){david.stage=nS;displayMessage(`Evolved to ${nS}!`);document.getElementById('ageDisplay').textContent=`Age: ${david.age} days (${david.stage})`;createParticles(50,canvas.width/2,david.posY,C_YELLOW,'burst');if(nS==='child'){david.stats.happiness=Math.min(david.maxStats.happiness,david.stats.happiness+20);david.stats.energy=david.maxStats.energy;}if(nS==='senior'){displayMessage("Welcome to your golden years... they'll be tough!");}}
        function checkDeath(){if(david.isDead)return;let dR="";const sDT=david.stage==='senior'?5:8;const sADT=david.stage==='senior'?8:12;if(david.stats.hunger<=0&&david.stats.happiness<=0&&david.stats.energy<=0&&david.stage!=='egg'){dR="severe neglect.";}else if(david.stats.hunger<=0&&david.stage!=='egg'){david.hungerDeathWarnTicks++;if(david.hungerDeathWarnTicks>sDT)dR="starvation.";}else{david.hungerDeathWarnTicks=0;}if(david.stats.happiness<=0&&david.stage!=='egg'){david.sadDeathWarnTicks++;if(david.sadDeathWarnTicks>sADT)dR="broken heart.";}else{david.sadDeathWarnTicks=0;}if(dR){david.isDead=true;displayMessage(`Passed away: ${dR}`);gameOver(`Lived ${david.age} days. Died of ${dR}`);}}
        
        function interpolateColor(c1,c2,f){const r1=parseInt(c1.substring(1,3),16);const g1=parseInt(c1.substring(3,5),16);const b1=parseInt(c1.substring(5,7),16);const r2=parseInt(c2.substring(1,3),16);const g2=parseInt(c2.substring(3,5),16);const b2=parseInt(c2.substring(5,7),16);const r=Math.round(r1+f*(r2-r1));const g=Math.round(g1+f*(g2-g1));const b=Math.round(b1+f*(b2-b1));return `#${r.toString(16).padStart(2,'0')}${g.toString(16).padStart(2,'0')}${b.toString(16).padStart(2,'0')}`;};
        function draw(){ctx.clearRect(0,0,canvas.width,canvas.height);const sK=david.stage==='egg'?'egg':(david.stage==='child'?'child':(david.stage==='teen'?'teen':(david.stage==='adult'?'adult':'senior')));const bS=BACKGROUNDS[sK];let tP=gameTimeOfDay/DAY_NIGHT_CYCLE_DURATION;let sC,gC;if(tP<0.25){sC=interpolateColor(bS.sky[1],bS.sky[0],tP/0.25);gC=interpolateColor(bS.ground[1],bS.ground[0],tP/0.25);}else if(tP<0.75){sC=bS.sky[0];gC=bS.ground[0];}else{sC=interpolateColor(bS.sky[0],bS.sky[1],(tP-0.75)/0.25);gC=interpolateColor(bS.ground[0],bS.ground[1],(tP-0.75)/0.25);}canvas.style.backgroundColor=sC;if(currentMinigame && currentMinigame.type !== 'blackjack'){drawMinigame();}else{ctx.fillStyle=gC;ctx.fillRect(0,canvas.height-40,canvas.width,40);drawDavid();drawActionItem();}drawParticles();}

        function updateUI(){['happiness','hunger','cleanliness','energy','smartness','experience'].forEach(s=>{const bE=document.getElementById(`${s}Bar`);if(bE)bE.style.width=david.stats[s]+'%';});colorBar(document.getElementById('happinessBar'),david.stats.happiness);colorBar(document.getElementById('hungerBar'),david.stats.hunger);colorBar(document.getElementById('cleanlinessBar'),david.stats.cleanliness);colorBar(document.getElementById('energyBar'),david.stats.energy);document.getElementById('moneyDisplay').textContent=`Money: $${david.money}`;document.getElementById('ageDisplay').textContent=`Age: ${david.age} days (${david.stage})`;document.getElementById('rentDisplay').textContent=`Rent: $${david.rent}`;document.getElementById('jobInfoArea').textContent=david.job?`Job: ${david.job.name} ($${david.job.basePay}/task) Exp: ${parseFloat(david.stats.experience).toFixed(1)}`:"Job: None";const iE=david.stage==='egg';const cA=(i)=>david.money>=COSTS[i];document.getElementById('feedButton').disabled=david.isSleeping||currentAction||iE||!cA('feed')||currentMinigame;document.getElementById('feedButton').textContent=`Feed ($${COSTS.feed})`;document.getElementById('cleanButton').disabled=david.isSleeping||currentAction||iE||!cA('clean')||currentMinigame;document.getElementById('cleanButton').textContent=`Clean ($${COSTS.clean})`;document.getElementById('playButton').disabled=david.isSleeping||currentAction||iE||david.stats.energy<20||!cA('play')||currentMinigame;document.getElementById('playButton').textContent=`Play ($${COSTS.play})`;document.getElementById('studyButton').disabled=david.isSleeping||currentAction||iE||david.stats.energy<30||(david.stage==='child'&&david.stats.smartness>=30)||!cA('study')||currentMinigame;document.getElementById('studyButton').textContent=`Study ($${COSTS.study})`;document.getElementById('sleepButton').disabled=(currentAction&&!david.isSleeping)||iE||currentMinigame;const cB=document.getElementById('choreButton'),jB=document.getElementById('jobButton'),pB=document.getElementById('promotionButton'),lFJB=document.getElementById('lookForJobButton'),gambleBtn=document.getElementById('gambleButton');[cB,jB,pB,lFJB].forEach(b=>b.style.display='none');
            if(!iE&&!currentAction&&!david.isSleeping&&!currentMinigame){
                if(david.job){
                    const jobCanDo=david.stats.energy>=david.job.energyCost;
                    if(david.job.type==='chore'&&david.stage==='child'){cB.style.display='inline-block';cB.disabled=!jobCanDo;}
                    else if(david.job.type==='part-time'&&(david.stage==='teen'||david.stage==='senior')){jB.style.display='inline-block';jB.disabled=!jobCanDo;pB.style.display='inline-block';pB.disabled=david.daysSincePromotionAttempt>0 || david.stage === 'senior';} // No promotions for senior jobs defined here
                    else if(david.job.type==='full-time'&&(david.stage==='adult')){jB.style.display='inline-block';jB.disabled=!jobCanDo;pB.style.display='inline-block';pB.disabled=david.daysSincePromotionAttempt>0;}
                }
                if(david.stage==='adult'||david.stage==='senior'){
                    lFJB.style.display='inline-block'; lFJB.disabled=false;
                    gambleBtn.style.display='inline-block'; gambleBtn.disabled = david.money < 1;
                } else {
                    lFJB.style.display='none';
                    gambleBtn.style.display='none';
                }
            } else { // If egg, action, sleeping, or minigame active
                [cB,jB,pB,lFJB,gambleBtn].forEach(b=> { if (b) b.style.display='none';});
                if (!iE && (david.stage==='adult'||david.stage==='senior')) { // Still show for adult/senior if not doing anything else
                     if (lFJB) lFJB.style.display = currentMinigame || currentAction || david.isSleeping ? 'none' : 'inline-block';
                     if (gambleBtn) gambleBtn.style.display = currentMinigame || currentAction || david.isSleeping ? 'none' : 'inline-block';
                }
            }
        }
        function colorBar(el,val){if(!el)return;if(val<30)el.style.backgroundColor=C_RED;else if(val<60)el.style.backgroundColor=C_YELLOW;else el.style.backgroundColor=C_GREEN;}
        function displayMessage(msg){const ma=document.getElementById('messageArea');ma.textContent=msg;setTimeout(()=>{if(ma.textContent===msg){/*ma.textContent="";*/}},4000);}
        function startAction(t,d,e,c){if(currentAction||david.isSleeping||david.stage==='egg'||currentMinigame)return false;if(david.money<c){displayMessage(`Need $${c} for ${t}.`);return false;}david.money-=c;currentAction={type:t,duration:d,effects:e};actionTimer=d;disableControls();let i="";switch(t){case'feed':i="apple";break;case'clean':i="soap";break;case'play':i="ball";break;case'study':i="book";break;}displayMessage(`David is ${t}ing with ${i}...`);updateUI();return true;}
        function finishAction(){if(!currentAction)return;
            const seniorEffectMultiplier = david.stage === 'senior' ? 0.7 : 1.0; // Actions are less effective for seniors
            const originalEffects = currentAction.effects;
            currentAction.effects = () => {
                const tempStats = {...david.stats}; // Store stats before applying original effects
                originalEffects(); // Apply original effects
                if (david.stage === 'senior' && seniorEffectMultiplier < 1.0) {
                    for (const stat in david.stats) {
                        if (stat === 'happiness' || stat === 'hunger' || stat === 'cleanliness' || stat === 'energy' || stat === 'smartness') {
                            const gain = david.stats[stat] - tempStats[stat];
                            if (gain > 0) { // Only reduce positive gains
                                david.stats[stat] = tempStats[stat] + (gain * seniorEffectMultiplier);
                            }
                        }
                    }
                }
            };
            currentAction.effects();
            createParticles(20,david.posX,david.posY-(5*PIXEL_SCALE),C_YELLOW,currentAction.type==='clean'?'bubbles':'burst');displayMessage(`Finished ${currentAction.type}ing.${david.stage === 'senior' ? ' (Felt less effective...)' : ''}`);currentAction=null;enableControls();processStatDecay();}
        document.getElementById('feedButton').addEventListener('click',()=>{if(david.stats.hunger>=david.maxStats.hunger){displayMessage("Not hungry.");return;}startAction('feed',60,()=>{david.stats.hunger=Math.min(david.maxStats.hunger,david.stats.hunger+35);david.stats.happiness=Math.min(david.maxStats.happiness,david.stats.happiness+5);david.stats.cleanliness=Math.max(0,david.stats.cleanliness-3);},COSTS.feed);});
        document.getElementById('cleanButton').addEventListener('click',()=>{if(david.stats.cleanliness>=david.maxStats.cleanliness){displayMessage("Already clean!");return;}startAction('clean',90,()=>{david.stats.cleanliness=david.maxStats.cleanliness;david.stats.happiness=Math.min(david.maxStats.happiness,david.stats.happiness+15);},COSTS.clean);});
        document.getElementById('playButton').addEventListener('click',()=>{if(david.stats.energy<20){displayMessage("Too tired.");return;}if(david.stats.happiness>=david.maxStats.happiness){displayMessage("Happy!");return;}startAction('play',120,()=>{david.stats.happiness=Math.min(david.maxStats.happiness,david.stats.happiness+30);david.stats.energy=Math.max(0,david.stats.energy-25);david.stats.cleanliness=Math.max(0,david.stats.cleanliness-5);},COSTS.play);});
        document.getElementById('studyButton').addEventListener('click',()=>{if(david.stage==='child'&&david.stats.smartness>=30){displayMessage("Learned enough.");return;}if(david.stats.energy<30){displayMessage("Too tired.");return;}if(david.stats.smartness>=david.maxStats.smartness){displayMessage("Genius!");return;}startAction('study',150,()=>{david.stats.smartness=Math.min(david.maxStats.smartness,david.stats.smartness+10);david.stats.energy=Math.max(0,david.stats.energy-20);david.stats.happiness=Math.max(0,david.stats.happiness-3);david.stats.experience=Math.min(david.maxStats.experience,david.stats.experience+2);},COSTS.study);});
        document.getElementById('sleepButton').addEventListener('click',toggleSleep);
        document.getElementById('choreButton').addEventListener('click',()=>{if(david.job&&david.job.type==='chore')startMinigame(david.job);});
        document.getElementById('jobButton').addEventListener('click',()=>{if(david.job&&(david.job.type==='part-time'||david.job.type==='full-time'))startMinigame(david.job);});

        function getHappinessTollClass(toll) {
            if (toll <= -1.5) return 'job-toll-high';
            if (toll <= -0.8) return 'job-toll-medium';
            return 'job-toll-low';
        }

        document.getElementById('lookForJobButton').addEventListener('click',()=>{
            if(currentAction||currentMinigame||david.isSleeping)return;
            let jobPool=[]; let jobType = 'full-time';
            if(david.stage==='adult')jobPool=JOB_TIERS.adult;
            else if(david.stage==='senior'){jobPool=JOB_TIERS.senior; jobType = 'part-time';}
            else return;

            const qualifiedJobs=jobPool.filter(j=>david.stats.smartness>=j.smartnessMin&&david.stats.experience>=j.expMin);
            jobChoiceContainer.innerHTML = '';

            if (david.job) {
                const currentOptionDiv = document.createElement('div');
                currentOptionDiv.className = 'job-option current-job';
                currentOptionDiv.innerHTML = `<p class="job-title">${david.job.name} (Current)</p><p class="job-detail">Pay: $${david.job.basePay}/task</p><p class="job-detail">Toll: <span class="${getHappinessTollClass(david.job.happinessToll)}">${david.job.happinessToll} Hap</span></p><button>Stay</button>`;
                currentOptionDiv.querySelector('button').onclick = () => { jobChoiceOverlay.style.display = 'none'; enableControls(); };
                jobChoiceContainer.appendChild(currentOptionDiv);
            }

            const otherQualified = qualifiedJobs.filter(j => !david.job || j.id !== david.job.id);
            otherQualified.sort(() => 0.5 - Math.random());
            const optionsToShow = otherQualified.slice(0, 3);

            if (optionsToShow.length === 0 && !david.job) { displayMessage("No jobs available for your current skills yet."); return; }
            
            optionsToShow.forEach(jobData => {
                const optionDiv = document.createElement('div');
                optionDiv.className = 'job-option';
                optionDiv.innerHTML = `<p class="job-title">${jobData.name}</p><p class="job-detail">Pay: $${jobData.basePay}/task</p><p class="job-detail">Toll: <span class="${getHappinessTollClass(jobData.happinessToll)}">${jobData.happinessToll} Hap</span></p><p class="job-detail">(Requires: ${jobData.smartnessMin} Smrt, ${jobData.expMin} Exp)</p><button>Take Job</button>`;
                optionDiv.querySelector('button').onclick = () => {
                    david.job = {type: jobType, ...jobData, tasksToday: 0, tasksYesterday: 0, data: jobData};
                    displayMessage(`Started new job: ${david.job.name}!`);
                    david.stats.happiness = Math.min(david.maxStats.happiness, david.stats.happiness + (david.stage === 'senior' ? -5 : 5) ); // Smaller boost or penalty for seniors
                    jobChoiceOverlay.style.display = 'none';
                    enableControls(); updateUI();
                };
                jobChoiceContainer.appendChild(optionDiv);
            });

             if (optionsToShow.length > 0 || david.job) { jobChoiceOverlay.style.display = 'flex'; disableControls(true); }
             else if (optionsToShow.length === 0 && david.job) { displayMessage("No other suitable jobs found right now."); jobChoiceOverlay.style.display = 'flex'; disableControls(true); /* Still show current job */ }

        });

        document.getElementById('promotionButton').addEventListener('click',()=>{if(!david.job||david.daysSincePromotionAttempt>0|| david.stage === 'senior')return; // No promotions for seniors in this setup
            const d=david.job;let c=d.promotionBaseChance+d.tasksYesterday*d.promotionBonusPerTask+david.stats.smartness*d.promotionBonusPerSmartness+david.stats.experience*d.promotionBonusPerExp;c=Math.min(0.9,c);david.daysSincePromotionAttempt=3;if(Math.random()<c){const oP=d.basePay;d.basePay=Math.ceil(oP*(1.15+Math.random()*0.1));displayMessage(`Promotion! Pay: $${oP} -> $${d.basePay}.`);createParticles(40,canvas.width/2,david.posY,C_GREEN,'burst');david.stats.happiness=Math.min(david.maxStats.happiness,david.stats.happiness+20);}else{displayMessage("Promotion denied.");david.stats.happiness=Math.max(0,david.stats.happiness-10);}updateUI();});
        function toggleSleep(){if(david.stage==='egg'||currentMinigame){displayMessage("Cannot sleep.");return;}david.isSleeping=!david.isSleeping;if(david.isSleeping){displayMessage("Sleeping...");document.getElementById('sleepButton').textContent="Wake Up";disableControls(true);}else{displayMessage("Woke up!");document.getElementById('sleepButton').textContent="Sleep";enableControls();processStatDecay();}updateUI();}
        
        function disableControls(isSpecialOverlay=false){
            const buttonsToDisable = ['feedButton','cleanButton','playButton','studyButton','choreButton','jobButton','promotionButton','lookForJobButton','gambleButton'];
            buttonsToDisable.forEach(id=>{const btn=document.getElementById(id); if(btn) btn.disabled=true;});
            document.getElementById('sleepButton').disabled=david.stage==='egg'||(!isSpecialOverlay&¤tAction)||isSpecialOverlay;
        }
        function enableControls(){updateUI();}
        function gameOver(m){if(gameLoopId)cancelAnimationFrame(gameLoopId);clearInterval(statDecayInterval);clearInterval(ageInterval);clearInterval(playtimeIntervalId);disableControls(true);['typingMinigameOverlay','programmerMinigameOverlay','managerMinigameOverlay','jobChoiceOverlay','blackjackOverlay'].forEach(id=>document.getElementById(id).style.display='none');canvasMinigameInfo.style.display='none';currentMinigame=null;document.getElementById('finalMessage').textContent=m;document.getElementById('gameOverScreen').style.display='flex';isGamePaused=true;}
        document.getElementById('restartButton').addEventListener('click',()=>{document.getElementById('gameOverScreen').style.display='none';startGame();});
        function handleVisibilityChange(){if(document.hidden){if(!isGamePaused&&!david.isDead){isGamePaused=true;pauseOverlay.style.display='flex';if(statDecayInterval)clearInterval(statDecayInterval);if(ageInterval)clearInterval(ageInterval);if(playtimeIntervalId)clearInterval(playtimeIntervalId);displayMessage("Game Paused (Tabbed Out)");}}else{if(isGamePaused&&!david.isDead){isGamePaused=false;pauseOverlay.style.display='none';lastTickTime=performance.now();if(statDecayInterval)clearInterval(statDecayInterval);statDecayInterval=setInterval(processStatDecay,STAT_DECAY_INTERVAL);if(ageInterval)clearInterval(ageInterval);ageInterval=setInterval(updateAge,AGE_SPEED);if(playtimeIntervalId)clearInterval(playtimeIntervalId);playtimeIntervalId=setInterval(updatePlaytimeDisplay,1000);if(gameLoopId)cancelAnimationFrame(gameLoopId);gameLoopId=requestAnimationFrame(gameLoop);displayMessage("Game Resumed");if(currentMinigame && currentMinigame.type !== 'blackjack'){const jobData=currentMinigame.jobDataRef;if(jobData.minigameType==='typing'){document.getElementById('typingTimeLeft').textContent=Math.ceil(currentMinigame.state.timeLeftFrames/60);}else if(jobData.minigameType==='sequence_memory'){document.getElementById('programmerTimeLeft').textContent=Math.ceil(currentMinigame.state.timeLeftFrames/60);}else if(jobData.minigameType==='timed_reaction_button'){document.getElementById('managerTimeLeft').textContent=Math.ceil(currentMinigame.state.timeLeftFrames/60);}else if(jobData.minigameType==='click_scattered'||jobData.minigameType==='click_fill_slots'){canvasMinigameInfo.innerHTML=`... | Time: ${Math.ceil(currentMinigame.state.timeLeftFrames/60)}s`;}}}}}
        document.addEventListener("visibilitychange",handleVisibilityChange,false);

        function formatTime(ms) {
            const totalSeconds = Math.floor(ms / 1000);
            const hours = Math.floor(totalSeconds / 3600);
            const minutes = Math.floor((totalSeconds % 3600) / 60);
            const seconds = totalSeconds % 60;
            return `Playtime: ${hours.toString().padStart(2,'0')}:${minutes.toString().padStart(2,'0')}:${seconds.toString().padStart(2,'0')}`;
        }
        function updatePlaytimeDisplay() {
            if (isGamePaused || david.isDead) return;
            const elapsed = performance.now() - sessionStartTime;
            playtimeDisplay.textContent = formatTime(elapsed);
        }

        // Blackjack Logic
        function createBlackjackDeck() {
            const deck = [];
            for (const suit of SUITS) {
                for (const rank of RANKS) {
                    deck.push({ suit, rank, value: getCardValue(rank), display: rank + suit });
                }
            }
            return deck;
        }

        function shuffleDeck(deck) {
            for (let i = deck.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [deck[i], deck[j]] = [deck[j], deck[i]];
            }
        }

        function getCardValue(rank, currentScore = 0) {
            if (['K', 'Q', 'J', 'T'].includes(rank)) return 10;
            if (rank === 'A') return currentScore + 11 > 21 ? 1 : 11;
            return parseInt(rank);
        }

        function calculateHandValue(hand) {
            let score = 0;
            let aceCount = 0;
            for (const card of hand) {
                if (card.rank === 'A') aceCount++;
                score += getCardValue(card.rank);
            }
            // Adjust for Aces
            while (score > 21 && aceCount > 0) {
                score -= 10; // Change an Ace from 11 to 1
                aceCount--;
            }
            return score;
        }

        function renderCardToDOM(card, isHidden = false) {
            const cardDiv = document.createElement('div');
            cardDiv.classList.add('card');
            if (isHidden) {
                cardDiv.classList.add('hidden');
                cardDiv.textContent = '??';
            } else {
                cardDiv.textContent = card.display;
                if (card.suit === '♥' || card.suit === '♦') {
                    cardDiv.classList.add('red');
                }
            }
            return cardDiv;
        }

        function updateBlackjackUIDisplay() {
            if (!currentMinigame || currentMinigame.type !== 'blackjack') return;
            const state = currentMinigame.state;

            blackjackPlayerHandDisplay.innerHTML = '';
            state.playerHand.forEach(card => blackjackPlayerHandDisplay.appendChild(renderCardToDOM(card)));
            blackjackPlayerScoreDisplay.textContent = state.playerScore;

            blackjackDealerHandDisplay.innerHTML = '';
            state.dealerHand.forEach((card, index) => {
                blackjackDealerHandDisplay.appendChild(renderCardToDOM(card, index === 0 && state.phase !== 'round_over' && state.phase !== 'dealer_turn_reveal'));
            });
            
            if (state.phase === 'round_over' || state.phase === 'dealer_turn_reveal' || state.dealerScore > 0 && state.dealerHand.length === 2 && state.playerScore === 21 && state.playerHand.length === 2) { // Show dealer score if round over or BJ check
                 blackjackDealerScoreDisplay.textContent = state.dealerScore;
            } else if (state.dealerHand.length > 0 && state.phase !== 'betting') { // Show only visible card value
                 blackjackDealerScoreDisplay.textContent = state.dealerHand.length > 1 ? getCardValue(state.dealerHand[1].rank) : '0'; // Show second card's value if exists
            } else {
                 blackjackDealerScoreDisplay.textContent = '0';
            }

            blackjackBetInput.max = david.money + (state.phase === 'betting' ? 0 : currentMinigame.state.currentBet); // Allow betting up to current money OR current bet if mid-round (for UI consistency)
        }
        
        function dealBlackjackCard(handArray, isDealerHiddenInitialCard = false) {
            const card = currentMinigame.state.deck.pop();
            handArray.push(card);
            if (isDealerHiddenInitialCard) {
                currentMinigame.state.dealerHiddenCard = card;
            }
            return card;
        }

        document.getElementById('gambleButton').addEventListener('click', () => {
            if (david.stage !== 'adult' && david.stage !== 'senior') {
                displayMessage("Only adults and seniors can gamble."); return;
            }
            if (david.money < 1) {
                displayMessage("Not enough money to gamble."); return;
            }
            startMinigame('blackjack');
        });

        blackjackDealButton.addEventListener('click', () => {
            if (!currentMinigame || currentMinigame.type !== 'blackjack') return;
            const betAmount = parseInt(blackjackBetInput.value);
            if (isNaN(betAmount) || betAmount < 1 || betAmount > david.money) {
                blackjackMessageDisplay.textContent = "Invalid bet amount.";
                return;
            }

            currentMinigame.state.currentBet = betAmount;
            david.money -= betAmount;
            updateUI(); // Update money display

            currentMinigame.state.deck = createBlackjackDeck();
            shuffleDeck(currentMinigame.state.deck);
            currentMinigame.state.playerHand = [];
            currentMinigame.state.dealerHand = [];
            
            dealBlackjackCard(currentMinigame.state.playerHand);
            dealBlackjackCard(currentMinigame.state.dealerHand, true); // Dealer's first card hidden
            dealBlackjackCard(currentMinigame.state.playerHand);
            dealBlackjackCard(currentMinigame.state.dealerHand);

            currentMinigame.state.playerScore = calculateHandValue(currentMinigame.state.playerHand);
            // Calculate dealer's full score for potential BJ check, but don't display full yet
            currentMinigame.state.dealerScore = calculateHandValue(currentMinigame.state.dealerHand);


            currentMinigame.state.phase = 'player_turn';
            blackjackBetControls.style.display = 'none';
            blackjackActionControls.style.display = 'flex';
            blackjackMessageDisplay.textContent = "Your turn. Hit or Stand?";
            
            updateBlackjackUIDisplay();

            // Check for Blackjack
            const playerHasBlackjack = currentMinigame.state.playerScore === 21 && currentMinigame.state.playerHand.length === 2;
            const dealerHasBlackjack = currentMinigame.state.dealerScore === 21 && currentMinigame.state.dealerHand.length === 2;

            if (playerHasBlackjack) {
                currentMinigame.state.phase = 'round_over'; // To reveal dealer's card
                updateBlackjackUIDisplay(); // Show dealer's hand
                if (dealerHasBlackjack) {
                    blackjackMessageDisplay.textContent = "Push! Both have Blackjack.";
                    david.money += currentMinigame.state.currentBet; // Return bet
                } else {
                    blackjackMessageDisplay.textContent = `Blackjack! You win $${currentMinigame.state.currentBet * 1.5}!`;
                    david.money += currentMinigame.state.currentBet + (currentMinigame.state.currentBet * 1.5); // Bet back + 1.5x winnings
                }
                endBlackjackRound();
            } else if (dealerHasBlackjack) {
                currentMinigame.state.phase = 'round_over';
                updateBlackjackUIDisplay(); // Show dealer's hand
                blackjackMessageDisplay.textContent = "Dealer Blackjack. You lose.";
                // Money already taken
                endBlackjackRound();
            }
        });

        blackjackHitButton.addEventListener('click', () => {
            if (!currentMinigame || currentMinigame.type !== 'blackjack' || currentMinigame.state.phase !== 'player_turn') return;
            
            dealBlackjackCard(currentMinigame.state.playerHand);
            currentMinigame.state.playerScore = calculateHandValue(currentMinigame.state.playerHand);
            updateBlackjackUIDisplay();

            if (currentMinigame.state.playerScore > 21) {
                blackjackMessageDisplay.textContent = `Bust! You lose $${currentMinigame.state.currentBet}.`;
                endBlackjackRound();
            } else if (currentMinigame.state.playerScore === 21) {
                blackjackMessageDisplay.textContent = "You have 21! Standing.";
                handleBlackjackStand(); // Auto-stand on 21
            }
        });

        blackjackStandButton.addEventListener('click', handleBlackjackStand);

        function handleBlackjackStand() {
            if (!currentMinigame || currentMinigame.type !== 'blackjack' || currentMinigame.state.phase !== 'player_turn') return;
            
            currentMinigame.state.phase = 'dealer_turn_reveal'; // To show full dealer score
            updateBlackjackUIDisplay(); // Reveal dealer's hidden card and full score
            currentMinigame.state.phase = 'dealer_turn';


            blackjackActionControls.style.display = 'none'; // Disable player actions

            // Dealer plays
            setTimeout(dealerPlayLoop, 800); // Add a small delay for effect
        }
        
        function dealerPlayLoop() {
            if (!currentMinigame || currentMinigame.type !== 'blackjack' || currentMinigame.state.phase !== 'dealer_turn') return;

            currentMinigame.state.dealerScore = calculateHandValue(currentMinigame.state.dealerHand); // Recalculate to be sure
            updateBlackjackUIDisplay();


            if (currentMinigame.state.dealerScore < 17) {
                blackjackMessageDisplay.textContent = "Dealer hits...";
                dealBlackjackCard(currentMinigame.state.dealerHand);
                currentMinigame.state.dealerScore = calculateHandValue(currentMinigame.state.dealerHand);
                updateBlackjackUIDisplay();
                setTimeout(dealerPlayLoop, 1000); // Next dealer action
            } else {
                // Dealer stands or busts
                if (currentMinigame.state.dealerScore > 21) {
                    blackjackMessageDisplay.textContent = `Dealer busts! You win $${currentMinigame.state.currentBet}!`;
                    david.money += currentMinigame.state.currentBet * 2;
                } else {
                    if (currentMinigame.state.playerScore > currentMinigame.state.dealerScore) {
                        blackjackMessageDisplay.textContent = `You win $${currentMinigame.state.currentBet}!`;
                        david.money += currentMinigame.state.currentBet * 2;
                    } else if (currentMinigame.state.playerScore < currentMinigame.state.dealerScore) {
                        blackjackMessageDisplay.textContent = `Dealer wins. You lose $${currentMinigame.state.currentBet}.`;
                    } else {
                        blackjackMessageDisplay.textContent = "Push! Bet returned.";
                        david.money += currentMinigame.state.currentBet;
                    }
                }
                endBlackjackRound();
            }
        }

        function endBlackjackRound() {
            currentMinigame.state.phase = 'round_over';
            blackjackActionControls.style.display = 'none';
            blackjackBetControls.style.display = 'flex';
            blackjackBetInput.max = david.money; // Update max bet for next round
             blackjackBetInput.value = Math.max(1, Math.min(currentMinigame.state.currentBet || 10, david.money)); // Suggest previous or default bet
            updateUI(); // Update main money display
        }

        blackjackCloseButton.addEventListener('click', () => {
            endMinigame(true); // true just signifies normal closure for blackjack
        });
        
        function closeBlackjackTable() {
            blackjackOverlay.style.display = 'none';
            currentMinigame = null;
            enableControls();
            updateUI();
            displayMessage("Left the Blackjack table.");
        }


        function startGame(){initDavid();if(gameLoopId)cancelAnimationFrame(gameLoopId);if(statDecayInterval)clearInterval(statDecayInterval);if(ageInterval)clearInterval(ageInterval);if(playtimeIntervalId)clearInterval(playtimeIntervalId);statDecayInterval=setInterval(processStatDecay,STAT_DECAY_INTERVAL);ageInterval=setInterval(updateAge,AGE_SPEED);playtimeIntervalId=setInterval(updatePlaytimeDisplay,1000);lastTickTime=performance.now();gameLoopId=requestAnimationFrame(gameLoop);}
        startGame();
    </script>
</body>
</html>
